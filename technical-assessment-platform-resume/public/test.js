let state=null;let countdown=null;let remaining=0;async function fetchState(){const res=await fetch('/api/state');const data=await res.json();if(!res.ok)throw new Error(data.error||'Failed');state=data;render()}function render(){if(!state)return;document.getElementById('position').textContent=`Question ${state.currentIndex+1} of ${state.total}`;document.getElementById('language').textContent=state.question.language;document.getElementById('progressBar').style.width=(state.progress||0)+'%';document.getElementById('questionText').textContent=state.question.question;const opts=document.getElementById('options');opts.innerHTML='';state.question.options.forEach((opt,idx)=>{const id=`opt-${idx}`;const label=document.createElement('label');label.className='radio';label.innerHTML=`<input type="radio" name="answer" value="${idx}" id="${id}"> ${opt}`;opts.appendChild(label);});if(typeof state.selectedAnswer==='number'){const sel=document.getElementById(`opt-${state.selectedAnswer}`);if(sel)sel.checked=true;}remaining=state.question.timeLimit;startTimer();document.getElementById('prevBtn').disabled=state.currentIndex<=0;document.getElementById('nextBtn').disabled=state.currentIndex>=state.total-1}function startTimer(){clearInterval(countdown);const timerEl=document.getElementById('timer');countdown=setInterval(async()=>{remaining-=1;timerEl.textContent=`Time: ${remaining}s`;if(remaining<=0){clearInterval(countdown);if(state.currentIndex<state.total-1){await navigate('next')}else{await submit()}}},1000)}async function saveAnswer(){const selected=document.querySelector('input[name=\"answer\"]:checked');if(!selected)return;await fetch('/api/answer',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({questionId:state.question.id,answerIndex:parseInt(selected.value,10)})})}async function navigate(direction){await saveAnswer();await fetch('/api/navigate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({direction})});await fetchState()}async function submit(){await saveAnswer();const res=await fetch('/api/submit',{method:'POST'});const data=await res.json();if(!res.ok){const msg=document.getElementById('msg');msg.textContent=data.error||'Failed to submit';msg.classList.add('error');return;}window.location.href='/result.html'}document.getElementById('prevBtn').addEventListener('click',()=>navigate('prev'));document.getElementById('nextBtn').addEventListener('click',()=>navigate('next'));document.getElementById('submitBtn').addEventListener('click',submit);fetchState();